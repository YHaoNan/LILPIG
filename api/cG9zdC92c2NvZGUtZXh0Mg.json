{"title":"VSCode 扩展开发(二) 第一个插件","date":"2019-06-03T00:00:54.000Z","slug":"vscode-ext2","tags":["editor","vscode"],"categories":["VSCode"],"updated":"2019-06-21T11:41:54.000Z","content":"<h2 id=\"学习目标\">学习目标<a href=\"post/vscode-ext2#学习目标\"></a></h2><p>本篇您将使用VSCode官方的代码生成工具生成您的第一个插件，并扩展它，且会对插件开发的流程有一个大致的了解。</p>\n<h2 id=\"环境安装\">环境安装<a href=\"post/vscode-ext2#环境安装\"></a></h2><p><strong>PS:开发VSCode Extensions需要node环境和git，请自行安装nodejs和git，并且保证以下命令可以运行：</strong><br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">git --version</span><br><span class=\"line\">npm -v</span><br></pre></td></tr></table></figure></p>\n<p>VSCode官方给开发者提供了插件项目生成工具，可以使用npm安装它们。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">npm install -g yo generator-code</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"您的第一个插件\">您的第一个插件<a href=\"post/vscode-ext2#您的第一个插件\"></a></h2><p>刚刚我们安装了官方提供的代码生成工具，我们现在用它来生成我们的第一个VSCode插件。</p>\n<p>在您想要生成项目的目录下运行<code>yo code</code>，之后他为了帮助您生成不同类型的VSCode Extension，会询问您一些问题。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  vscode-tutorial yo code</span><br><span class=\"line\"></span><br><span class=\"line\">     _-----_     ╭──────────────────────────╮</span><br><span class=\"line\">    |       |    │   Welcome to the Visual  │</span><br><span class=\"line\">    |--(o)--|    │   Studio Code Extension  │</span><br><span class=\"line\">   `---------´   │        generator!        │</span><br><span class=\"line\">    ( _´U`_ )    ╰──────────────────────────╯</span><br><span class=\"line\">    /___A___\\   /</span><br><span class=\"line\">     |  ~  |     </span><br><span class=\"line\">   __<span class=\"string\">'.___.'</span>__   </span><br><span class=\"line\"> ´   `  |° ´ Y ` </span><br><span class=\"line\"></span><br><span class=\"line\">? What <span class=\"built_in\">type</span> of extension <span class=\"keyword\">do</span> you want to create? (Use arrow keys)</span><br><span class=\"line\">❯ New Extension (TypeScript) </span><br><span class=\"line\">  New Extension (JavaScript) </span><br><span class=\"line\">  New Color Theme </span><br><span class=\"line\">  New Language Support </span><br><span class=\"line\">  New Code Snippets </span><br><span class=\"line\">  New Keymap </span><br><span class=\"line\">  New Extension Pack </span><br><span class=\"line\">(Move up and down to reveal more choices)</span><br></pre></td></tr></table></figure></p>\n<p>它在询问你想创建什么类型的扩展，并且提供了很多类型。这里我们选择<code>New Extension (TypeScript)</code>，如果您使用JavaScript开发请选择第二个。</p>\n<p>然后它又开始询问你一些问题：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 您的扩展叫什么名字 hello-world</span><br><span class=\"line\">? What&apos;s the name of your extension? hello-world</span><br><span class=\"line\"># 您扩展的id 唯一标识 hello-world</span><br><span class=\"line\">? What&apos;s the identifier of your extension? hello-world</span><br><span class=\"line\"># 您扩展的介绍 My first VSCode Extension.</span><br><span class=\"line\">? What&apos;s the description of your extension? My first VSCode Extension.</span><br><span class=\"line\"># 是否初始化一个git仓库 Yes</span><br><span class=\"line\">? Initialize a git repository? Yes</span><br><span class=\"line\"># 使用什么包管理器 npm</span><br><span class=\"line\">? Which package manager to use? npm</span><br></pre></td></tr></table></figure></p>\n<p>全部填写完毕后，它就会自动生成一个以你的扩展名为名字的文件夹，所有的代码都在这里。</p>\n<p>我们使用VSCode打开它，这里推荐直接使用命令行打开：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">code hello-world</span><br></pre></td></tr></table></figure></p>\n<p>因为如果您把这个插件目录添加到VSCode的工作区的话，某些情况下VSCode无法确定您要把哪一个目录当成插件运行，您也就无法测试您插件。而用命令只是打开一个文件夹，不存在这个问题。</p>\n<h2 id=\"目录结构\">目录结构<a href=\"post/vscode-ext2#目录结构\"></a></h2><p>可以看到一个VSCode Extension的目录结构如下：</p>\n<div class=\"article-img\"><p><img src=\"http://nsimg.cn-bj.ufileos.com/img-1559521012403.png\" alt=\"img\" data-zoomable></p></div>\n<p>其实这么多文件，我们大概只需要关心两个。src中有一个<code>extension.ts</code>，这是我们编写插件的主文件，我们插件的代码就是在这里面编写。另一个就是外层的<code>package.json</code>，这是nodejs项目都有的一个文件，我们编写插件时有很多东西要在这里注册后才能使用。</p>\n<p>其他的文件用的不多了，src下的test是测试目录，测试代码可以在这里编写，node_modules是我们项目中用到的依赖库的文件夹。</p>\n<h2 id=\"运行\">运行<a href=\"post/vscode-ext2#运行\"></a></h2><p>点击F5运行我们的插件(我在我的Windows环境和Linux环境下都需要第二次运行才可以，第一次不会有任何反应)。</p>\n<p>然后你会看到弹出了一个新的VSCode窗口，在这里我们按<code>Ctrl+Shift+P</code>打开命令窗口，输入Hello World。</p>\n<div class=\"article-img\"><p><img src=\"http://nsimg.cn-bj.ufileos.com/img-1559521444192.png\" alt=\"img\" data-zoomable></p></div>\n<p>可以看到，有这么一个命令，这是VSCode的插件生成工具帮我们自动生成的。我们按回车执行它，会发现右下角弹出一个通知消息。</p>\n<div class=\"article-img\"><p><img src=\"http://nsimg.cn-bj.ufileos.com/img-1559521510184.png\" alt=\"img\" data-zoomable></p></div>\n<p>至此，您的第一个VSCode Extension就开发完成了，再见！</p>\n<h2 id=\"WTF！！！\">WTF！！！<a href=\"post/vscode-ext2#WTF！！！\"></a></h2><p>停，我还什么都没干呢啊！怎么的就开发完了啊？？</p>\n<p>刚刚都是VSCode代码生成器帮我们自动生成的，我们来看看它都干了什么？我们先关注下<code>extension.ts</code>。<br><figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> * <span class=\"keyword\">as</span> vscode <span class=\"keyword\">from</span> <span class=\"string\">'vscode'</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">activate</span>(<span class=\"params\">context: vscode.ExtensionContext</span>) </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"built_in\">console</span>.log(<span class=\"string\">'Congratulations, your extension \"hello-world\" is now active!'</span>);</span><br><span class=\"line\">    <span class=\"comment\">//关注这一行和里面的匿名函数</span></span><br><span class=\"line\">\t<span class=\"keyword\">let</span> disposable = vscode.commands.registerCommand(<span class=\"string\">'extension.helloWorld'</span>, <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">\t\tvscode.window.showInformationMessage(<span class=\"string\">'Hello World!'</span>);</span><br><span class=\"line\">\t&#125;);</span><br><span class=\"line\">    <span class=\"comment\">//每注册一个命令都要调用这个方法把返回结果push进去</span></span><br><span class=\"line\">\tcontext.subscriptions.push(disposable);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">deactivate</span>(<span class=\"params\"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>尽管现在我们不知道VSCode提供的这些花里胡哨的API都是干嘛的，但是根据语义，我们能分析出来它调用<code>vscode.commands.registerCommand</code>注册了一个命令，并且给了一个类似id的东西<code>extension.helloWorld</code>，还有一个匿名函数，函数里调用<code>vscode.window.showInformationMessage</code>显示了一条信息，是<code>Hello World!</code>。</p>\n<p>而<code>activate</code>和<code>deactivate</code>则是我们的扩展的两个生命周期函数，<code>activate</code>就是当我们的扩展被激活的回调，而<code>deactivate</code>则是我们的扩展被关闭时的回调，你可以在这里做一些释放资源的操作。</p>\n<p>至此我们就知道了整个插件的大致的运行过程，就是注册命令之后传递一个匿名方法，然后命令被调用，匿名方法就会被回调。不妨我们照猫画虎，再注册一个。</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> disposable = vscode.commands.registerCommand(<span class=\"string\">'extension.helloWorld'</span>, <span class=\"function\"><span class=\"params\">()</span> =&gt;</span> &#123;</span><br><span class=\"line\">    vscode.window.showInformationMessage(<span class=\"string\">'Hello World!'</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> disposable2 = vscode.commands.registerCommand(<span class=\"string\">'extension.shadiao'</span>, <span class=\"function\"><span class=\"params\">()</span>=&gt;</span>&#123;</span><br><span class=\"line\">    vscode.window.showInformationMessage(<span class=\"string\">'无论我变成什么亚子，都鱼女无瓜！'</span>);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">context.subscriptions.push(disposable);</span><br><span class=\"line\"><span class=\"comment\">//虽然我暂时不知道这是干嘛的但是 模仿上一行</span></span><br><span class=\"line\">context.subscriptions.push(disposable2);</span><br></pre></td></tr></table></figure>\n<p>可以看到我们完全照猫画虎注册了一个<code>extension.shadiao</code>，我们运行一下看看。</p>\n<p>现在你可能已经打开了测试窗口，并且按下了<code>Ctrl+Shift+P</code>打开了命令窗口，但是你现在愣住了，你不知道干什么了。</p>\n<p>刚刚生成器帮我注册那个，我是输入了Hello World就找到了对应的命令，但是我自己注册这个我应该输入什么呢？？自动生成的Hello World是在哪里声明的？</p>\n<p>于是你回去看了看<code>extension.ts</code>的代码，发现确实没有<code>Hello World</code>的痕迹，虽然<code>registerCommand</code>方法有一个<code>extension.helloWorld</code>参数，但这个显然不是。</p>\n<p>诶？？这个<code>extension.helloWorld</code>是干嘛的？我刚刚说过是命令的id对吧，那注册这个id有什么用呢？？我们去另一个比较有用的文件<code>package.json</code>中看看。</p>\n<p>你看到了这样一段代码：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\"contributes\": &#123;</span><br><span class=\"line\">    \"commands\": [&#123;</span><br><span class=\"line\">        \"command\": \"extension.helloWorld\",</span><br><span class=\"line\">        \"title\": \"Hello World\"</span><br><span class=\"line\">    &#125;]</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>分析分析，大概知道怎么回事了，<code>contributes.commands</code>节点是一个放置所有注册的命令的列表，你注册过的所有命令必须在这里声明。</p>\n<p>这里面自带这个应该是生成器帮我们生成的，使用<code>command</code>指定命令的id，也就是你在<code>registerCommand</code>中的第一个参数，使用<code>title</code>指定命令的标题，这下你应该看出来了，命令面板中就是使用命令标题来寻找一个命令的。所以我们把我们自己注册那个也声明一下。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\"commands\": [&#123;</span><br><span class=\"line\">    \"command\": \"extension.helloWorld\",</span><br><span class=\"line\">    \"title\": \"Hello World\"</span><br><span class=\"line\">&#125;,&#123;</span><br><span class=\"line\">    \"command\": \"extension.shadiao\",</span><br><span class=\"line\">    \"title\": \"你为什么总是带着面罩啊？\"</span><br><span class=\"line\">&#125;]</span><br></pre></td></tr></table></figure>\n<p>好，我们预测一下现在运行会是什么效果，我们在命令面板里输入：<code>你为什么总是带着面罩啊？</code>，就会查找到我们的命令，然后执行，下面就会提示：<code>无论我变成什么亚子，都鱼女无瓜！</code>(Ohhh这是个梗，估计你们这帮搞技术的秃瓢是不会理解的…Ohh对不起对不起xD)。</p>\n<p>好，我们运行它，然后发现，事情好像并不是我们想象的那样，当我们执行这个命令时，下面弹出了一条错误提示：</p>\n<div class=\"article-img\"><p><img src=\"http://nsimg.cn-bj.ufileos.com/img-1559522859156.png\" alt=\"img\" data-zoomable></p></div>\n<p>什么？命令没找到？VSCode瞎了吗？我明明package.json里也写了，extension.ts里也写了，你怎么还找不到？你是个成熟的编辑器了，应该学会自己找到我的命令了。</p>\n<p>去查了官方文档，原来是因为VSCode考虑到性能问题使用了类似懒加载的模式，并不是一打开就加载所有的扩展，所以当我们从命令窗口选择我们的命令时，我们的扩展还没被激活，所以将命令和处理函数绑定的方法<code>registerCommand</code>还没有被实际的调用，所以就会出现这个问题。</p>\n<p>那我们的扩展什么时候被激活呢？VSCode提供了一个<code>activationEvents</code>选项去设置它，这个选项包含了一个列表，通过这个列表指定我们的扩展何时被激活。</p>\n<p>在<code>package.json</code>中找到<code>activationEvents</code>这个节点，它肯定存在，是代码生成器帮我们生成的，目前应该是这样的：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\"activationEvents\": [</span><br><span class=\"line\">    <span class=\"string\">\"onCommand:extension.helloWorld\"</span></span><br><span class=\"line\">],</span><br></pre></td></tr></table></figure></p>\n<p>可以看到目前这个列表里有一个项目，从语义上分析，我们知道这是当命令<code>extension.helloWorld</code>被调用时，激活扩展。</p>\n<p>看到这，我想你一定知道了应该把我们刚刚注册那个命令也添加进这个列表，让我们这个命令被调用时，扩展也能激活。确实应该是这样，但是我们不妨想一想，如果我们现在不添加我们的命令到激活列表，而是直接运行后先调用<code>extension.helloWorld</code>之后，插件被激活了，再调用我们那个命令应该就不会出现命令未找到这样的提示了。我们试试。</p>\n<div class=\"article-img\"><p><img src=\"http://nsimg.cn-bj.ufileos.com/img-1559538458860.png\" alt=\"img\" data-zoomable></p></div>\n<p>确实，两个命令都正确的执行了。但是如果在生产环境中，我们不知道用户会先执行哪个命令，所以我们应该把所有的命令都加进去(除非特殊需求)。</p>\n<p>所以，修改<code>package.json</code>的<code>activationEvents</code>节点：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\"activationEvents\": [</span><br><span class=\"line\">    \"onCommand:extension.helloWorld\",</span><br><span class=\"line\">    <span class=\"string\">\"onCommand:extension.shadiao\"</span></span><br><span class=\"line\">],</span><br></pre></td></tr></table></figure></p>\n<p>这样一来，先执行我们定义的命令也可以了。</p>\n<p>当然，<code>activationEvents</code>还有别的激活条件，不单单是当命令被调用时，这些就是后话了。</p>\n<p>至此，我们的第一个插件和它的执行流程就理清了，收拾收拾，看看下一篇吧！</p>\n<p><strong><a href=\"/post/vscode-ext1#目录\">点此返回目录</a></strong></p>\n<hr>\n<h2 id=\"参考文档\">参考文档<a href=\"post/vscode-ext2#参考文档\"></a></h2><ul>\n<li><a href=\"https://code.visualstudio.com/api/get-started/your-first-extension\" target=\"_blank\" rel=\"noopener\">get-started/your-first-extension</a></li>\n<li><a href=\"https://code.visualstudio.com/api/extension-guides/command\" target=\"_blank\" rel=\"noopener\">extension-guides/command</a></li>\n</ul>\n","prev":{"title":"VSCode 扩展开发(三) Command详解","slug":"vscode-ext3"},"next":{"title":"VSCode 扩展开发(一) 概述","slug":"vscode-ext1"},"link":"http://lilpig.site/post/vscode-ext2/","toc":[{"title":"学习目标","id":"学习目标","index":"1"},{"title":"环境安装","id":"环境安装","index":"2"},{"title":"您的第一个插件","id":"您的第一个插件","index":"3"},{"title":"目录结构","id":"目录结构","index":"4"},{"title":"运行","id":"运行","index":"5"},{"title":"WTF！！！","id":"WTF！！！","index":"6"},{"title":"参考文档","id":"参考文档","index":"7"}],"reward":true,"copyright":{"author":"LIL PIG","link":"<a href=\"http://lilpig.site/post/vscode-ext2/\" title=\"VSCode 扩展开发(二) 第一个插件\">http://lilpig.site/post/vscode-ext2/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}