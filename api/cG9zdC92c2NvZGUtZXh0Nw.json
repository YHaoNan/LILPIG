{"title":"VSCode 扩展开发(七) 实战-翻译插件","date":"2019-06-08T03:35:54.000Z","slug":"vscode-ext7","tags":["editor","vscode"],"categories":["VSCode"],"updated":"2019-06-21T11:42:35.759Z","content":"<h2 id=\"学习目标\">学习目标<a href=\"post/vscode-ext7#学习目标\"></a></h2><p>本章和接下来一章都是实战相关的插件。</p>\n<p>本章主要制作一个翻译插件，提供悬停翻译和划词翻译，整篇翻译和注释翻译，并且会学到一些TextEditor的API。</p>\n<h2 id=\"注册API服务\">注册API服务<a href=\"post/vscode-ext7#注册API服务\"></a></h2><p>首先我们使用百度翻译API进行翻译工作，所以请前往<a href=\"http://api.fanyi.baidu.com/api/trans/product/index\" target=\"_blank\" rel=\"noopener\">百度翻译开放平台</a>去注册开发者账号。</p>\n<p>注册后到管理控制台-&gt;开发者信息中去查看APP Id和秘钥。</p>\n<p>通用翻译API HTTP地址：</p>\n<p><a href=\"http://api.fanyi.baidu.com/api/trans/vip/translate\" target=\"_blank\" rel=\"noopener\">http://api.fanyi.baidu.com/api/trans/vip/translate</a></p>\n<p>通用翻译API HTTPS地址：</p>\n<p><a href=\"https://fanyi-api.baidu.com/api/trans/vip/translate\" target=\"_blank\" rel=\"noopener\">https://fanyi-api.baidu.com/api/trans/vip/translate</a></p>\n<p>API参数：</p>\n<div class=\"article-bounded\"><div class=\"article-table\"><table class=\"info-table\">\n<tbody><tr>\n<th>字段名</th>\n<th>类型</th>\n<th>必填参数</th>\n<th>描述</th>\n<th class=\"last-co\">备注</th>\n</tr>\n<tr>\n<td>q</td>\n<td>TEXT</td>\n<td>Y</td>\n<td>请求翻译query</td>\n<td>UTF-8编码</td>\n</tr>\n<tr>\n<td>from</td>\n<td>TEXT</td>\n<td>Y</td>\n<td>翻译源语言</td>\n<td><a href=\"#languageList\" class=\"doc-nav-item\" data-index=\"1\">语言列表</a>(可设置为auto)</td>\n</tr>\n<tr>\n<td>to</td>\n<td>TEXT</td>\n<td>Y</td>\n<td>译文语言</td>\n<td><a href=\"#languageList\" class=\"doc-nav-item\" data-index=\"1\">语言列表</a>(不可设置为auto)</td>\n</tr>\n<tr>\n<td>appid</td>\n<td>INT</td>\n<td>Y</td>\n<td>APP ID</td>\n<td>可在<a class=\"goto-console\" href=\"/api/trans/product/desktop?req=developer\">管理控制台</a>查看</td>\n</tr>\n<tr>\n<td>salt</td>\n<td>INT</td>\n<td>Y</td>\n<td>随机数</td>\n<td></td>\n</tr>\n<tr>\n<td>sign</td>\n<td>TEXT</td>\n<td>Y</td>\n<td>签名</td>\n<td>appid+q+salt+密钥 的MD5值</td>\n</tr>\n</tbody></table></div></div>\n\n<p>签名生成方法如下：</p>\n<ol>\n<li><p>将请求参数中的 APPID(appid), 翻译query(q, 注意为UTF-8编码), 随机数(salt), 以及平台分配的密钥(可在管理控制台查看)按照 appid+q+salt+密钥 的顺序拼接得到字符串1。</p>\n</li>\n<li><p>对字符串1做md5，得到32位小写的sign。</p>\n</li>\n</ol>\n<p>知道了这些，我们就可以开始编写代码了，新建一个项目，地址在<a href=\"https://github.com/YHaoNan/vscode-tutorial/tree/master/vsc-extensions-tutorial-7\" target=\"_blank\" rel=\"noopener\">这里</a></p>\n<p>返回的格式请自己查看API吧。</p>\n<h2 id=\"编写代码\">编写代码<a href=\"post/vscode-ext7#编写代码\"></a></h2><p>我们先把请求的库写好，我们统一使用Https的POST接口，然后使用axios库进行请求。</p>\n<p>请在工程目录下执行<code>npm install axios --save</code>安装axios库。</p>\n<p>因为appid和秘钥，还有目标语言都需要用户进行设置，所以我们编写<code>package.json</code>提供设置项：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\"configuration\": [&#123;</span><br><span class=\"line\">    \"title\": \"Translator\",</span><br><span class=\"line\">    \"properties\": &#123;</span><br><span class=\"line\">        \"ts.to\": &#123;</span><br><span class=\"line\">        \"type\": \"string\",</span><br><span class=\"line\">        \"default\": \"zh\",</span><br><span class=\"line\">        \"description\": \"The language that you wanna translate to\"</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        \"ts.appid\": &#123;</span><br><span class=\"line\">        \"type\": [</span><br><span class=\"line\">            \"integer\",</span><br><span class=\"line\">            <span class=\"string\">\"null\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        \"default\": null,</span><br><span class=\"line\">        \"description\": \"Your appid\"</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        \"ts.key\": &#123;</span><br><span class=\"line\">        \"type\": [</span><br><span class=\"line\">            \"string\",</span><br><span class=\"line\">            <span class=\"string\">\"null\"</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        \"default\": null,</span><br><span class=\"line\">        \"description\": \"Your key\"</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;]</span><br></pre></td></tr></table></figure></p>\n<p>然后提供一个util工具类，用于获取设置、生成随机数字和加密：</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> * <span class=\"keyword\">as</span> vscode <span class=\"keyword\">from</span> <span class=\"string\">'vscode'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123;Md5&#125; <span class=\"keyword\">from</span> <span class=\"string\">\"md5-typescript\"</span>;</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">let</span> getConfig = &lt;T&gt;(key: <span class=\"built_in\">string</span>): <span class=\"function\"><span class=\"params\">T</span>=&gt;</span>&lt;T&gt;vscode.workspace.getConfiguration().get&lt;T&gt;(key);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//生成指定长度的随机数字</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">let</span> genRandomNumber = (len: <span class=\"built_in\">number</span>): <span class=\"function\"><span class=\"params\">number</span>=&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> getRandomInt(<span class=\"built_in\">Math</span>.pow(<span class=\"number\">10</span>,len<span class=\"number\">-1</span>),<span class=\"built_in\">Math</span>.pow(<span class=\"number\">10</span>,len)<span class=\"number\">-1</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//生成Sign，也就是加密信息</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">let</span> genSign = (appid: <span class=\"built_in\">string</span>,q: <span class=\"built_in\">string</span>,salt: <span class=\"built_in\">string</span>,key:<span class=\"built_in\">string</span>): <span class=\"function\"><span class=\"params\">string</span> =&gt;</span> Md5.init(appid+q+salt+key);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getRandomInt</span>(<span class=\"params\">min: <span class=\"built_in\">number</span>, max: <span class=\"built_in\">number</span></span>): <span class=\"title\">number</span> </span>&#123;  </span><br><span class=\"line\">    <span class=\"keyword\">var</span> Range = max - min;  </span><br><span class=\"line\">    <span class=\"keyword\">var</span> Rand = <span class=\"built_in\">Math</span>.random();  </span><br><span class=\"line\">    <span class=\"keyword\">return</span>(min + <span class=\"built_in\">Math</span>.round(Rand * Range));  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>编写请求库<br><figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> axios <span class=\"keyword\">from</span> <span class=\"string\">'axios'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> * <span class=\"keyword\">as</span> utils <span class=\"keyword\">from</span> <span class=\"string\">'./utils'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//返回码映射到错误信息</span></span><br><span class=\"line\"><span class=\"keyword\">const</span> ERROR_MSG: &#123;[index:<span class=\"built_in\">string</span>]:<span class=\"built_in\">string</span>&#125;= &#123;</span><br><span class=\"line\">    <span class=\"string\">'52001'</span>: <span class=\"string\">'请求超时，请重试'</span>,</span><br><span class=\"line\">    <span class=\"string\">'52002'</span>: <span class=\"string\">'系统错误'</span>,</span><br><span class=\"line\">    <span class=\"string\">'52003'</span>: <span class=\"string\">'请检查您的appid是否正确'</span>,</span><br><span class=\"line\">    <span class=\"string\">'54000'</span>: <span class=\"string\">'参数不完整'</span>,</span><br><span class=\"line\">    <span class=\"string\">'54001'</span>: <span class=\"string\">'签名错误'</span>,</span><br><span class=\"line\">    <span class=\"string\">'58000'</span>: <span class=\"string\">'客户端IP非法'</span>,</span><br><span class=\"line\">    <span class=\"string\">'54005'</span>: <span class=\"string\">'长query请求过于频繁，请稍后再试'</span>,</span><br><span class=\"line\">    <span class=\"string\">'58001'</span>: <span class=\"string\">'译文语言不支持'</span>,</span><br><span class=\"line\">    <span class=\"string\">'58002'</span>: <span class=\"string\">'您的服务已关闭'</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">const</span> API_URL = <span class=\"string\">'https://fanyi-api.baidu.com/api/trans/vip/translate'</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">translate</span>(<span class=\"params\">source:<span class=\"built_in\">string</span></span>): <span class=\"title\">Promise</span>&lt;<span class=\"title\">string</span>&gt;</span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//准备数据</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> data:&#123;[index:<span class=\"built_in\">string</span>]:<span class=\"built_in\">string</span>&#125; = &#123;</span><br><span class=\"line\">        q: source,</span><br><span class=\"line\">        <span class=\"keyword\">from</span>: <span class=\"string\">'auto'</span>,</span><br><span class=\"line\">        to: utils.getConfig(<span class=\"string\">'ts.to'</span>),</span><br><span class=\"line\">        appid: utils.getConfig&lt;<span class=\"built_in\">string</span>&gt;(<span class=\"string\">'ts.appid'</span>),</span><br><span class=\"line\">        salt: utils.genRandomNumber(<span class=\"number\">10</span>).toString(),</span><br><span class=\"line\">        sign: <span class=\"string\">''</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    data.sign = utils.genSign(data.appid,data.q,data.salt,utils.getConfig&lt;<span class=\"built_in\">string</span>&gt;(<span class=\"string\">'ts.key'</span>));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//设置header为 form-urlencoded</span></span><br><span class=\"line\">    axios.defaults.headers.post[<span class=\"string\">'Content-Type'</span>] = <span class=\"string\">'application/x-www-form-urlencoded'</span>;</span><br><span class=\"line\">    <span class=\"comment\">//设置transformRequest用于格式化数据 转成querystring 因为API规定不能直接用JSON格式的数据所以要如此苦逼的写这些</span></span><br><span class=\"line\">    axios.defaults.transformRequest = [<span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">data</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> ret = <span class=\"string\">''</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">let</span> it <span class=\"keyword\">in</span> data) &#123;</span><br><span class=\"line\">        ret += <span class=\"built_in\">encodeURIComponent</span>(it) + <span class=\"string\">'='</span> + <span class=\"built_in\">encodeURIComponent</span>(data[it]) + <span class=\"string\">'&amp;'</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> ret;</span><br><span class=\"line\">    &#125;];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">//发送请求</span></span><br><span class=\"line\">        <span class=\"keyword\">const</span> result = <span class=\"keyword\">await</span> axios.post(API_URL,data);</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"comment\">//如果有结果 则返回</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span>(result.data.trans_result)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> results: <span class=\"built_in\">any</span>[] = result.data.trans_result;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> targetStr:<span class=\"built_in\">string</span> = results.map(<span class=\"function\"><span class=\"params\">obj</span>=&gt;</span>obj.dst).join(<span class=\"string\">'\\n'</span>);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">Promise</span>.resolve(targetStr);</span><br><span class=\"line\">        <span class=\"comment\">//如果没有结果 检查有没有错误码 有的话调用reject</span></span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(result.data.error_code)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> msg = ERROR_MSG[result.data.error_code <span class=\"keyword\">as</span> <span class=\"built_in\">string</span>];</span><br><span class=\"line\">            msg=msg?msg:<span class=\"string\">'未知错误'</span>;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">Promise</span>.reject(msg);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">catch</span>(e)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">Promise</span>.reject(e.message);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>编写<code>extensions.ts</code>，暂时提供两种翻译手段，一个是通过<code>HoverProvider</code>提供悬停事件，在悬停的单词上翻译，一个是通过命令翻译当前编辑器的选中部分。<br><figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> * <span class=\"keyword\">as</span> vscode <span class=\"keyword\">from</span> <span class=\"string\">'vscode'</span>;</span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123;TranslateHoverProvider&#125; <span class=\"keyword\">from</span> <span class=\"string\">'./hover'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> &#123;translate&#125; <span class=\"keyword\">from</span> <span class=\"string\">'./request'</span></span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">activate</span>(<span class=\"params\">context: vscode.ExtensionContext</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//注册Hover</span></span><br><span class=\"line\">\tcontext.subscriptions.push(</span><br><span class=\"line\">\t\tvscode.languages.registerHoverProvider(<span class=\"string\">'*'</span>,<span class=\"keyword\">new</span> TranslateHoverProvider())</span><br><span class=\"line\">\t);</span><br><span class=\"line\">    <span class=\"comment\">//注册翻译选中范围的命令</span></span><br><span class=\"line\">\tcontext.subscriptions.push(</span><br><span class=\"line\">\t\tvscode.commands.registerTextEditorCommand(<span class=\"string\">'ns.translateSelection'</span>, <span class=\"keyword\">async</span>(editor)=&gt;&#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> outputChannel = vscode.window.createOutputChannel(<span class=\"string\">'Translate Result'</span>);</span><br><span class=\"line\">            <span class=\"comment\">//兼容多光标</span></span><br><span class=\"line\">\t\t\teditor.selections.forEach(<span class=\"keyword\">async</span>(selection)=&gt;&#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">if</span>(!selection.isEmpty)&#123;</span><br><span class=\"line\">                    <span class=\"keyword\">let</span> source = editor.document.getText(selection);</span><br><span class=\"line\">\t\t\t\t\ttranslateAndShow(outputChannel,source);</span><br><span class=\"line\">\t\t\t\t&#125;</span><br><span class=\"line\">\t\t\t&#125;);</span><br><span class=\"line\">\t\t&#125;)</span><br><span class=\"line\">\t);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">async</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">translateAndShow</span>(<span class=\"params\">outputChannel:vscode.OutputChannel,source:<span class=\"built_in\">string</span></span>)</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">try</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">let</span> result = <span class=\"keyword\">await</span> translate(source);</span><br><span class=\"line\">\t\toutputChannel.appendLine(result);</span><br><span class=\"line\">\t\toutputChannel.show();\t</span><br><span class=\"line\">\t&#125;<span class=\"keyword\">catch</span>(e)&#123;</span><br><span class=\"line\">\t\tvscode.window.showErrorMessage(<span class=\"string\">'翻译器：'</span>+e);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">export</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">deactivate</span>(<span class=\"params\"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>editor的<code>selections</code>是一个<code>Selection</code>对象的数组，记录的是所有用户选中的地方。<code>Selection</code>是<code>Range</code>的子类，<code>Range</code>表示一个范围，它有<code>start</code>和<code>end</code>属性，分别代表起始位置和结束位置，这两个属性是<code>Position</code>类型，它代表一个位置，有<code>line</code>和<code>character</code>属性，分别表示这个位置所在的行和字符在本行的位置。</p>\n<p>所以我们这里判断每一个selection是否是空，如果不是就翻译那一段文字。</p>\n<p>请大家自行在<code>package.json</code>中注册，我们的翻译插件要求vscode打开时就激活，所以在<code>package.json</code>中写：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\"activationEvents\": [</span><br><span class=\"line\">    <span class=\"string\">\"*\"</span></span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure></p>\n<p>写星之后打开VSCode直接激活插件。</p>\n<h2 id=\"扩展\">扩展<a href=\"post/vscode-ext7#扩展\"></a></h2><p>添加翻译全文功能和翻译注释并替换原注释功能。</p>\n<p>翻译全文功能比较简单了，我们当用户没有选中段落的时候认为它想翻译全文，你可能会这样判断：<br><figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(editor.selections.length == <span class=\"number\">0</span>)</span><br></pre></td></tr></table></figure></p>\n<p>或者<br><figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//selection是当前的选中区域对象</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(editor.selection == <span class=\"literal\">null</span>)</span><br></pre></td></tr></table></figure></p>\n<p>可是这是不行的，因为上面说了，就算没选中也会有一个为空的selection，而且我们不能用<code>editor.selection</code>判断，因为用户可能有多个选中区域呢。</p>\n<p>所以我们打算在<code>editor.selections.forEach</code>里记录是否有被翻译的段落，如果没有那么就是全文了。</p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> isHasTranslatedSelection = <span class=\"literal\">false</span>;</span><br><span class=\"line\">editor.selections.forEach(<span class=\"keyword\">async</span>(selection)=&gt;&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!selection.isEmpty)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> source = editor.document.getText(selection);</span><br><span class=\"line\">        translateAndShow(outputChannel,source);</span><br><span class=\"line\">        isHasTranslatedSelection = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!isHasTranslatedSelection)&#123;</span><br><span class=\"line\">    translateAndShow(outputChannel,editor.document.getText());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>翻译全文很简单也很实用，下面一个就比较难了，下面是翻译注释并替换，这个也是很实用的功能，尤其在使用别人的库的时候，但这在不同的语言中需要不同的行为，因为不同的语言的注释块是不一样的。</p>\n<p>比如Python你需要兼容如下的注释：<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Single Line Comment</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">'''</span></span><br><span class=\"line\"><span class=\"string\">Multi Line Comment</span></span><br><span class=\"line\"><span class=\"string\">'''</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br><span class=\"line\"><span class=\"string\">Multi Line Comment</span></span><br><span class=\"line\"><span class=\"string\">\"\"\"</span></span><br></pre></td></tr></table></figure></p>\n<p>而在Java中你需要兼容如下的注释：<br><figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// Single Line Comment</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\">* Multi Line Comment</span></span><br><span class=\"line\"><span class=\"comment\">*/</span></span><br></pre></td></tr></table></figure></p>\n<p>其实大部分语言都是用<code>/**/</code>实现多行注释的，Java也一样，上面的Java多行注释只是Java程序员约定俗成的习惯而已。</p>\n<p>我们的示例仅仅支持单行注释，其余的留给各位自行扩展，哈哈其实我觉得常见到的应该是多行。</p>\n<p>对于单行注释，我们有如下的正则：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(\\/\\/|#)(.*)</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight typescript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">context.subscriptions.push(</span><br><span class=\"line\">    vscode.commands.registerTextEditorCommand(<span class=\"string\">'ns.translateComment'</span>, <span class=\"keyword\">async</span>(editor)=&gt;&#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> outputChannel = vscode.window.createOutputChannel(<span class=\"string\">'Translate Result'</span>);</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"keyword\">let</span> i=<span class=\"number\">0</span>;i&lt;editor.document.lineCount;i++)&#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> lineText = editor.document.lineAt(i).text;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> commentMatch = lineText.match(<span class=\"string\">'(\\/\\/|#)(.*)'</span>);</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(commentMatch)&#123;</span><br><span class=\"line\">                <span class=\"keyword\">let</span> result = <span class=\"keyword\">await</span> translate(commentMatch[<span class=\"number\">2</span>]);</span><br><span class=\"line\">                <span class=\"keyword\">let</span> start = lineText.indexOf(commentMatch[<span class=\"number\">2</span>]);</span><br><span class=\"line\">                <span class=\"keyword\">let</span> end = start + commentMatch[<span class=\"number\">2</span>].length;</span><br><span class=\"line\">                editor.edit(<span class=\"function\"><span class=\"params\">editorEdit</span>=&gt;</span>&#123;</span><br><span class=\"line\">                    editorEdit.replace(<span class=\"keyword\">new</span> vscode.Range(<span class=\"keyword\">new</span> vscode.Position(i,start),<span class=\"keyword\">new</span> vscode.Position(i,end)),result);</span><br><span class=\"line\">                &#125;)</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;&#125;)</span><br><span class=\"line\">);</span><br></pre></td></tr></table></figure>\n<p>上面的代码我们使用了<code>editor.edit</code>来替换编辑器中的内容，<code>editor.edit</code>传入一个<code>callback</code>，这个回调方法里有个参数是<code>TextEditorEdit</code>类型的，它有<code>delete</code>、<code>insert</code>、<code>replace</code>等方法可以让我们操作编辑器。</p>\n<p>好了，差不多了，今天就到这里了。</p>\n<p>其实这离一个成熟的翻译插件还差得远呢，比如不能根据语言识别不同的注释，注释需要发送多次请求等，代码复用性不高等，这些都是问题。不过我们的目的不是开发插件，是学开发插件，哈哈，真正的成熟的插件还得靠您各位以后慢慢的开发呐～</p>\n<p><strong><a href=\"/post/vscode-ext1#目录\">点此返回目录</a></strong></p>\n","prev":{"title":"VSCode 扩展开发(八) 实战-Markdown图片上传","slug":"vscode-ext8"},"next":{"title":"VSCode 扩展开发(六) 用户设置","slug":"vscode-ext6"},"link":"http://lilpig.site/post/vscode-ext7/","toc":[{"title":"学习目标","id":"学习目标","index":"1"},{"title":"注册API服务","id":"注册API服务","index":"2"},{"title":"编写代码","id":"编写代码","index":"3"},{"title":"扩展","id":"扩展","index":"4"}],"reward":true,"copyright":{"author":"LIL PIG","link":"<a href=\"http://lilpig.site/post/vscode-ext7/\" title=\"VSCode 扩展开发(七) 实战-翻译插件\">http://lilpig.site/post/vscode-ext7/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}