{"title":"Vue自定义命令","date":"2019-08-11T10:07:48.000Z","slug":"vue-custom-cmd","tags":["js","vue","前端"],"categories":["Vue"],"updated":"2019-08-15T10:27:22.018Z","content":"<style>\n    #exm{\n        text-align: left;\n    }\n    #exm iframe{\n        border: 2px #333 solid;\n        outline: none;\n        width:100%;\n    }\n    #exm button{\n        outline: none;\n        border: 2px #333 solid;\n        margin-top:10px;\n        background-color: #ddd;\n        padding: 10px;\n\n    }\n</style>\n\n<p>Vue除了<code>v-bind</code>、<code>v-if</code>这些优秀的内置命令外，还允许我们根据业务需求自定义命令。自定义命令和自定义组件的过程非常相似</p>\n<p>Vue中这样注册一个命令：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.directive(<span class=\"string\">'clickoutside'</span>,&#123;</span><br><span class=\"line\">    <span class=\"comment\">//...</span></span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure></p>\n<p>因为命令需要写在一个html元素上，所以可以注册很多html元素生命周期的钩子：</p>\n<ul>\n<li>bind: 只调用一次，指令第一此绑定到元素时调用</li>\n<li>inserted: 被绑定元素插入父节点时调用</li>\n<li>update: 被绑定元素所在模板更新时调用</li>\n<li>componentUpdate: 被绑定元素模板完成一次更新周期时调用</li>\n<li>unbind: 指令与元素解绑时调用</li>\n</ul>\n<p>我们可以通过以上的内容来编写一个自动获取焦点的输入框：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span> <span class=\"attr\">lang</span>=<span class=\"string\">\"en\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- ... --&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text\"</span> <span class=\"attr\">v-focus</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"undefined\"></span></span><br><span class=\"line\"><span class=\"javascript\">        Vue.directive(<span class=\"string\">'focus'</span>,&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            inserted: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">el</span>) </span>&#123;</span></span><br><span class=\"line\"><span class=\"undefined\">                el.focus();</span></span><br><span class=\"line\"><span class=\"undefined\">            &#125;</span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;);</span></span><br><span class=\"line\"><span class=\"javascript\">        <span class=\"keyword\">var</span> vm = <span class=\"keyword\">new</span> Vue(&#123;</span></span><br><span class=\"line\"><span class=\"javascript\">            el: <span class=\"string\">'#app'</span></span></span><br><span class=\"line\"><span class=\"undefined\">        &#125;);</span></span><br><span class=\"line\"><span class=\"undefined\">    </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- ... --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>我们监听了inserted钩子，当input被插入时立即获取焦点</p>\n<p>这些钩子还可以有其它的参数：</p>\n<ul>\n<li>el: 命令所绑定的元素</li>\n<li>binding: 一个对象，这个对象包含很多属性<ul>\n<li>name: 指令名</li>\n<li>value: 指令绑定值 如果是表达式则是计算后的值</li>\n<li>oldValue: 指令绑定的前一个值</li>\n<li>expression: 指令值的字符串形式</li>\n<li>arg: 传给指令的参数，如<code>v-bind:msg</code>，msg为arg</li>\n<li>modifiers: 指令的修饰符，如<code>@click.stop</code>，此时modifiers的值为{stop: true}</li>\n</ul>\n</li>\n<li>vnode: Vue编译生成的虚拟节点</li>\n<li>oldVnode: 上一个虚拟节点</li>\n</ul>\n<h2 id=\"下拉菜单\">下拉菜单<a href=\"post/vue-custom-cmd#下拉菜单\"></a></h2><p>我们开发一个下拉菜单，这个菜单当点击菜单以外的位置时会关闭。</p>\n<div id=\"exm\">\n    <iframe id=\"exm\" src=\"http://host.lilpig.site/vue-exm/pop_menu.html\"></iframe>\n    <a href=\"http://host.lilpig.site/vue-exm/pop_menu.html\" target=\"_blank\" rel=\"noopener\"><button>在浏览器中运行</button></a>\n</div>\n\n<p>分析需求，我们写一个<code>clickoutside</code>的命令，并且传入一个函数，如果点击<code>document</code>就调用这个函数，在这个函数中进行关闭。</p>\n<p>这是html代码：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"app\"</span> <span class=\"attr\">v-clickoutside</span>=<span class=\"string\">\"handleClose\"</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">button</span> @<span class=\"attr\">click</span>=<span class=\"string\">\"show = !show\"</span>&gt;</span>菜 单<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">br</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">\"menu\"</span> <span class=\"attr\">v-show</span>=<span class=\"string\">\"show\"</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">ul</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span>ITEM1<span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span>ITEM2<span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span>ITEM3<span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">ul</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>下面是js代码，原理就是给<code>document</code>添加和移除事件。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Vue.directive(<span class=\"string\">'clickoutside'</span>,&#123;</span><br><span class=\"line\">    inserted: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">el,binding,vnode</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">documentHandler</span>(<span class=\"params\">e</span>)</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (el.contains(e.target))&#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> <span class=\"literal\">false</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (binding.expression)&#123;</span><br><span class=\"line\">                binding.value(e);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        el.__vueClickOutSide__ = documentHandler;</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.addEventListener(<span class=\"string\">'click'</span>,documentHandler);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    unbind: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">el,binding</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"built_in\">document</span>.removeEventListener(<span class=\"string\">'click'</span>,el.__vueClickOutSide__);</span><br><span class=\"line\">        <span class=\"keyword\">delete</span> el.__vueClickOutSide__;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"><span class=\"keyword\">var</span> vm = <span class=\"keyword\">new</span> Vue(&#123;</span><br><span class=\"line\">    el: <span class=\"string\">'#app'</span>,</span><br><span class=\"line\">    data: &#123;</span><br><span class=\"line\">        show: <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    methods: &#123;</span><br><span class=\"line\">        handleClose: <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.show = <span class=\"literal\">false</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure></p>\n","prev":{"title":"Vue组件实例","slug":"vue-component-exm"},"next":{"title":"Vue中的组件","slug":"vue-component"},"link":"http://lilpig.site/post/vue-custom-cmd/","toc":[{"title":"下拉菜单","id":"下拉菜单","index":"1"}],"reward":true,"copyright":{"author":"LIL PIG","link":"<a href=\"http://lilpig.site/post/vue-custom-cmd/\" title=\"Vue自定义命令\">http://lilpig.site/post/vue-custom-cmd/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}