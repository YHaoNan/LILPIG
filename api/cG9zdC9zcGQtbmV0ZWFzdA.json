{"title":"分析网易云的JS加密","date":"2019-05-24T04:15:27.000Z","slug":"spd-neteast","tags":["Python","javascript","爬虫"],"categories":["爬虫"],"updated":"2019-05-24T06:18:02.409Z","content":"<h3 id=\"起源\">起源<a href=\"post/spd-neteast#起源\"></a></h3><p>最近想搞一个工具App，需要网易云的数据，所以要分析网易云的WebAPI。之前也写过很多爬虫，所以刚开始我是信心满满的，直到看见网易云的请求都是这个样子的：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">params: wVJpucPzzULoYCnoTXT809yc/SIgz8dCFVc6YBqaUhNzJ2YF2y5uA/vfByF1bQbLwI/5c9iIa3aHaEN2OMe+siNTh+MLWS6nqJKpn0P28SJ1BlO5uE7t8UPte8uOb3AoSLMtHkZ3Wqp8HmAhpVuc+u5xMoECk19oLTDGxYMjeBB1Y19gLKszcHi+thmTIn8N2BvR2EDVfS2CWWUvQsD2msJghlh9/eglF8uz4aKPA8NeSXccF8HxieefeWsJ6//jk0wYQMAaxeDqIJQiekFFMw==</span><br><span class=\"line\">encSecKey: d91f190d99d06d2400e0817cfbb7abfae5de48ea26091b42cb62eef0379350babd87078dfd3c9ac36eeef02e2e46dc9335e965bf2a9b3c99773caf31003dd4e0a5cdc710e2e44a26355231a44d7647d92b92d68c2e3a84951d36cedf92139241a8444a874b6b175f16c7401fea31770b0ebc6d2f09b444dd5807f38db1f53873</span><br></pre></td></tr></table></figure></p>\n<p>我就崩溃了，这肯定都是通过JS加密的，以前应对JS加密我从来都是用Selenium这种库+无头浏览器，效率底下还占资源，关键是应用场景有限，只是爬取数据用它可以，但是我要搞一个App的话，用Selenium就不行了。</p>\n<p>于是我只能分析它的JS代码，但是一般看见的js为了加载速度都是经过压缩的，网易云当然也是，几万行在一个文件里，变量名都是abcdefg，用开发者工具弄可能不太方便，效率也不高，而且你想改js代码应该是实现不了(虽说可以打断点)。于是百度了一下，找到了一个思路，就是用代理拦截对应的js请求，替换成本地的，这样就可以在本地的编辑器里编辑和阅读JS了。</p>\n<p>于是。。因为一点经验都没有，我搞了一上午，不过还是搞出来了，哈哈哈瞬间超级开心。</p>\n<h3 id=\"前戏\">前戏<a href=\"post/spd-neteast#前戏\"></a></h3><p>用到以下工具：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Charles(Windows下用Fiddler也可以 或者可以用Mono Fiddler)</span><br><span class=\"line\">一个浏览器(Chrome Dev)</span><br><span class=\"line\">一个编辑器(VSCode)</span><br></pre></td></tr></table></figure></p>\n<p>打开Charles，点<code>Help-&gt;SSL Proxying-&gt;Save Charles Root Certificate</code>保存Charles的根证书，因为我们要抓取的东西是HTTPS的，所以要用到。</p>\n<p>然后保存的证书是cer的，我们要转成crt并且复制到<code>/usr/share/ca-certificates</code>，并安装证书。<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl x509 -inform der -<span class=\"keyword\">in</span> CharlesRoot.cer -outform pem -out CharlesRoot.crt</span><br><span class=\"line\">sudo cp CharlesRoot.crt /usr/share/ca-certificates</span><br><span class=\"line\">sudo dpkg-reconfigure ca-certificates //选择ask,勾选CharlesRoot.crt并确认</span><br></pre></td></tr></table></figure></p>\n<p>然后点击<code>Proxy-&gt;Proxy Setting</code>，标签Proxies下勾选Enable transparent HTTP proxying。</p>\n<p>设置你的系统或浏览器使用你的代理端口，然后好像还得把你的证书安装到浏览器里，反正我的Chrome安装了。之后你就能看到浏览器收发的所有数据包了，你点开一个URL之后会发现全都是<code>Unknow</code>，这是因为你没开启该URL的HTTPS代理，右键该URL之后选择<code>Enable SSL Proxying</code>。</p>\n<p>现在应该就能看到该URL下HTTPS的流量了。</p>\n<h3 id=\"开始分析\">开始分析<a href=\"post/spd-neteast#开始分析\"></a></h3><p>PS：因为分析的目标JS代码经过压缩，基本不是给人看的，很恶心，所以注意力要集中哦。。。</p>\n<p>我们就用搜索单曲的例子来说吧，首先打开网易云音乐，然后搜索，在开发者工具的XHR请求里你应该会看到这个URL，这就是搜索的URL。</p>\n<div class=\"article-img\"><p><img src=\"http://prgs9av8q.bkt.clouddn.com/jt.png\" alt=\"IMG\" data-zoomable></p></div>\n<p>然后看到这是一个POST请求，直接去看它的Form Data，看到两串BASE64编码的奇怪的参数，一个是<code>params</code>一个是<code>encSecKey</code>，尝试直接Base64解密，解密后还是一堆加密过的参数，于是我们去分析它的JS。</p>\n<div class=\"article-img\"><p><img src=\"http://prgs9av8q.bkt.clouddn.com/jt2.png\" alt=\"IMG\" data-zoomable></p></div>\n<p>我们搜索一下关键词，encSecKey，发现只有一个叫<code>core_</code>什么的js文件中有。</p>\n<div class=\"article-img\"><p><img src=\"http://prgs9av8q.bkt.clouddn.com/jt3.png\" alt=\"IMG\" data-zoomable></p></div>\n<p>点进去，麻痹，45792行。。。。直接复制到VSCode里，保存到一个本地文件中，之后我们就分析这个文件。然后让我们的Charles去拦截并替换它。</p>\n<p>点击<code>Tools-&gt;Map Local</code>然后Enable Map Local，之后点击Add去添加一个文件映射。</p>\n<div class=\"article-img\"><p><img src=\"http://prgs9av8q.bkt.clouddn.com/jt4.png\" alt=\"IMG\" data-zoomable></p></div>\n<p>Host填那个JS文件的所在的主机，Path填JS文件名，这里要注意把后面的参数去了，Query选项才是填参数的地方，不过这里我们不管它参数是啥都拦截，所以就填星号。在Local Path中选择你本地文件所在的位置。</p>\n<p>完事，我们在第一行加一个<code>alert</code>或者注释，看一下是否真正替换了。</p>\n<p>替换完之后我们开始分析JS，先看哪个参数？先看长的，<code>encSecKey</code>这个，我们在整个JS文件里搜索它。</p>\n<p>发现一共就三处，最后两处在同一个地方，并且在那还发现了params，所以我们从这开始分析。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> bUP3x = <span class=\"built_in\">window</span>.asrsea(<span class=\"built_in\">JSON</span>.stringify(i4m), brC5H([<span class=\"string\">\"流泪\"</span>, <span class=\"string\">\"强\"</span>]), brC5H(WU0x.md), brC5H([<span class=\"string\">\"爱心\"</span>, <span class=\"string\">\"女孩\"</span>, <span class=\"string\">\"惊恐\"</span>, <span class=\"string\">\"大笑\"</span>]));</span><br><span class=\"line\">e4i.data = k4o.cz5E(&#123;</span><br><span class=\"line\">    params: bUP3x.encText,</span><br><span class=\"line\">    encSecKey: bUP3x.encSecKey</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>基本可以肯定，这里就是我们form data里看到的参数，这两个参数都来自于<code>bUP3x</code>，而这个变量是调用了<code>window.asrsea</code>的返回值，所以我们应该去asrsea中找，搜索一下会找到如下一段代码：<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">//...省略一些代码</span></span><br><span class=\"line\">    <span class=\"built_in\">window</span>.asrsea = d,</span><br><span class=\"line\">    <span class=\"built_in\">window</span>.ecnonasr = e</span><br><span class=\"line\">&#125;();</span><br></pre></td></tr></table></figure></p>\n<p>可以看到这里把d作为了<code>window.asrsea</code>的值，那么d是啥？d其实就在省略的代码里面，这里面有五个函数，分别是a b c d e，我们首先着重看d。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">d</span>(<span class=\"params\">d, e, f, g</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> h = &#123;&#125;</span><br><span class=\"line\">        , i = a(<span class=\"number\">16</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> h.encText = b(d, g),</span><br><span class=\"line\">    h.encText = b(h.encText, i),</span><br><span class=\"line\">    h.encSecKey = c(i, e, f),</span><br><span class=\"line\">    h</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>d有4个参数，是刚才我们分析的<code>bUP3x</code>那里传进去的，我们先不考虑它是啥，等分析完这段在讨论。我们先把它当成已知的。</p>\n<p>可以看到这里对于encText和encSecKey都赋值了，根据之前的代码我们可以知道，encText就是formdata里的params，encSecKey就是encSecKey。所以这个方法就是加密的核心。</p>\n<p>它对encText做了两次赋值，都是调用b，我们也可以看做<code>b(b(d,g),i)</code>，我个人感觉这样看比分开看清晰，因为这样看它们之间的关系比较强。</p>\n<p>我们看看b的代码。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">b</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> c = CryptoJS.enc.Utf8.parse(b)</span><br><span class=\"line\">        , d = CryptoJS.enc.Utf8.parse(<span class=\"string\">\"0102030405060708\"</span>)</span><br><span class=\"line\">        , e = CryptoJS.enc.Utf8.parse(a)</span><br><span class=\"line\">        , f = CryptoJS.AES.encrypt(e, c, &#123;</span><br><span class=\"line\">        iv: d,</span><br><span class=\"line\">        mode: CryptoJS.mode.CBC</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> f.toString()</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>b其实比较简单了，不过经过代码压缩之后看起来很乱，我们可以在脑海中给它修改一下，不难看出就是把第二个参数作为key，把一个字符串<code>0102030405060708</code>作为偏移量，然后对第一个参数进行AES加密，模式是CBC。</p>\n<p>我们再看一下d中对b的调用，是这样的<code>b(b(d,g),i)</code>，也就是说先用参数g作为key对参数d进行一次aes加密，再把i作为key和结果进行aes加密，d和g是外面传过来的，那i是哪来的？</p>\n<p>d中有这样一行<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> h = &#123;&#125;</span><br><span class=\"line\">    , i = a(<span class=\"number\">16</span>);</span><br></pre></td></tr></table></figure></p>\n<p>i是调用了a之后来的，我们继续分析a函数。<br><figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">a</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> d, e, b = <span class=\"string\">\"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\"</span>, c = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (d = <span class=\"number\">0</span>; a &gt; d; d += <span class=\"number\">1</span>)</span><br><span class=\"line\">        e = <span class=\"built_in\">Math</span>.random() * b.length,</span><br><span class=\"line\">        e = <span class=\"built_in\">Math</span>.floor(e),</span><br><span class=\"line\">        c += b.charAt(e);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> c</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>一眼就能看出这是生成了一个长度为a的随机字符串，而a即d中传过来的参数16，也就是说函数a返回长度为16的随机字符串。</p>\n<p>现在我们就知道encText是怎么来的了，我们知道params就是encText，所以我们已经解开了一个参数的加密过程了，但是还有一个疑问，就是d方法的参数都是啥，我们还不知道。我们回到调用<code>window.asrsea</code>的地方(因为通过分析我们知道d就是window.asrsea)去看看。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> bUP3x = <span class=\"built_in\">window</span>.asrsea(<span class=\"built_in\">JSON</span>.stringify(i4m), brC5H([<span class=\"string\">\"流泪\"</span>, <span class=\"string\">\"强\"</span>]), brC5H(WU0x.md), brC5H([<span class=\"string\">\"爱心\"</span>, <span class=\"string\">\"女孩\"</span>, <span class=\"string\">\"惊恐\"</span>, <span class=\"string\">\"大笑\"</span>]));</span><br><span class=\"line\">e4i.data = k4o.cz5E(&#123;</span><br><span class=\"line\">    params: bUP3x.encText,</span><br><span class=\"line\">    encSecKey: bUP3x.encSecKey</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>还是这段代码，我们发现第一个参数是一个由i4m变的json字符串，第二个第四个应该都是写死的，我也不知道为啥是这些，我也没分析，它都写死了，我们也不用浪费时间到这个上面。</p>\n<p>我们再看看第三个参数，是<code>WU0x.md</code>，找到这个变量的定义，其实也是一个写死的字符串，而且很长，我们不难看出第2，3，4个变量都是一些emoji的名字，不过为啥要加，我们无从得知，我们也不需要得知，既然它写死了，我们就直接复制，写爬虫就是这样嘛，能走捷径就走捷径。</p>\n<p>我们加两个console.log，把经过这些emoji经过<code>brC5H</code>之后的值打印出来。顺便打印出第一个参数。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">console</span>.log(<span class=\"built_in\">JSON</span>.stringify(i4m));</span><br><span class=\"line\"><span class=\"built_in\">console</span>.log(brC5H([<span class=\"string\">\"流泪\"</span>, <span class=\"string\">\"强\"</span>]), brC5H(WU0x.md), brC5H([<span class=\"string\">\"爱心\"</span>, <span class=\"string\">\"女孩\"</span>, <span class=\"string\">\"惊恐\"</span>, <span class=\"string\">\"大笑\"</span>]));</span><br></pre></td></tr></table></figure>\n<p>刷新下网页，重新请求，然后看控制台的输出，一次搜索操作<code>window.asrsea</code>方法被调用了多次，第一个参数是改变的，剩下三个参数的值是恒定不变的，而且我们可以看出<code>brC5H</code>方法是个加密方法或者是编码方法，不过因为它值被写死了，导致每次加密的值都一样，我们也就不用分析这个方法了。</p>\n<div class=\"article-img\"><p><img src=\"http://prgs9av8q.bkt.clouddn.com/jt5.png\" alt=\"IMG\" data-zoomable></p></div>\n<p>既然调用了多次，我们要知道哪次调用返回的结果才是我们发出请求的formdata中的参数，于是继续添加log，看看每次<code>window.asrsea</code>的返回值。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">console</span>.log(bUP3x);</span><br></pre></td></tr></table></figure>\n<p>window.asrsea返回值<br><img src=\"http://prgs9av8q.bkt.clouddn.com/jt6.png\" alt=\"window.asrsea返回值\"></p>\n<p>formdata参数<br><img src=\"http://prgs9av8q.bkt.clouddn.com/jt7.png\" alt=\"formdata参数\"></p>\n<p>我们可以找到这一次的返回值和参数对应上了，于是我们就看一看这次调用时它的可变参数，也就是第一个参数是什么。<br><figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;<span class=\"attr\">\"hlpretag\"</span>:<span class=\"string\">\"&lt;span class=\\\"s-fc7\\\"&gt;\"</span>,<span class=\"attr\">\"hlposttag\"</span>:<span class=\"string\">\"&lt;/span&gt;\"</span>,<span class=\"attr\">\"s\"</span>:<span class=\"string\">\"asdfasd\"</span>,<span class=\"attr\">\"type\"</span>:<span class=\"string\">\"1\"</span>,<span class=\"attr\">\"offset\"</span>:<span class=\"string\">\"0\"</span>,<span class=\"attr\">\"total\"</span>:<span class=\"string\">\"true\"</span>,<span class=\"attr\">\"limit\"</span>:<span class=\"string\">\"30\"</span>,<span class=\"attr\">\"csrf_token\"</span>:<span class=\"string\">\"\"</span>&#125;</span><br></pre></td></tr></table></figure></p>\n<p>一个json字符串，没经过格式化的，我们立马可以看出它就是我们的搜索参数，s即搜索关键字(我瞎打的)，offset即偏移位置，limit返回多少个。</p>\n<p>那么我们原封不懂的把他copy下来备用，然后别忘了，encSecKey这个参数我们还没有研究呢。</p>\n<p>继续回到函数d。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">d</span>(<span class=\"params\">d, e, f, g</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> h = &#123;&#125;</span><br><span class=\"line\">        , i = a(<span class=\"number\">16</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> h.encText = b(d, g),</span><br><span class=\"line\">    h.encText = b(h.encText, i),</span><br><span class=\"line\">    h.encSecKey = c(i, e, f),</span><br><span class=\"line\">    h</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>可以看到encSecKey调用了函数c，并且把i和ef传了进去，我们知道i是随机变量，e和f是写死的，那么我们不妨做出大胆的猜想，我们每次把随机字符串写死那么encSecKey应该返回的是同一个东西。</p>\n<p>这样做的话，参数e和f我们不用管了，也就是说我们关心的就是d和g，d我们知道了是那个json字符串，g的话我们去之前打印的结果里复制下就行了。efg这三个参数是不会变的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//这是g</span><br><span class=\"line\">0CoJUm6Qyw8W8jud</span><br></pre></td></tr></table></figure>\n<p>而且encText中也用到了i，写死的话，我们生成16位随机字符串的算法也不用写了。</p>\n<p>理一理头绪开始编码。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//准备一下这个json串，因为我们构造搜索关键字和返回结果时都用它控制</span><br><span class=\"line\">&#123;&quot;hlpretag&quot;:&quot;&lt;span class=\\&quot;s-fc7\\&quot;&gt;&quot;,&quot;hlposttag&quot;:&quot;&lt;/span&gt;&quot;,&quot;s&quot;:&quot;$searchKeyWord&quot;,&quot;type&quot;:&quot;1&quot;,&quot;offset&quot;:&quot;0&quot;,&quot;total&quot;:&quot;true&quot;,&quot;limit&quot;:&quot;30&quot;,&quot;csrf_token&quot;:&quot;&quot;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//把上面的$searchKeyWord替换成想搜索的就行了</span><br><span class=\"line\"></span><br><span class=\"line\">//我们知道params=b(b(d,g),i)</span><br><span class=\"line\">//那么先把这个json串以0CoJUm6Qyw8W8jud作为key进行aes加密，再把结果以随机变量i进行aes加密即可得到params</span><br><span class=\"line\"></span><br><span class=\"line\">//encSecKey我们准备写死，所以直接copy下来就可以</span><br><span class=\"line\">//因为这个encSecKey完全是由随机变量i决定的，那么我们就把当时的i也复制下来</span><br><span class=\"line\">//因为之前的时候没打印i，所以还得加行代码并且刷新</span><br><span class=\"line\">//这下formdata中的两个参数都出来了，我们开始编码</span><br><span class=\"line\"></span><br><span class=\"line\">//最后我们使用的encSecKey和随机变量如下</span><br><span class=\"line\">encSecKey： 0c76e2da719b4d3ab2ec44ccdd5100266f4b34cf6d7cd09c4de472aea01de6b1d476918225680680ddee41e02f1a5f19feee10bdea88c0b5bd7661ce5ab06212c7c53cce91d15ff6bc85e995251bb0ad6e240c9f2d4ae3d0631facc1dae8abc24703a66be6b98cd3250e6da7973e0286f7b6e3c1b474c8356961fc2126dc9ea7</span><br><span class=\"line\"></span><br><span class=\"line\">i： pIuxxPXdZv2yDPbr</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"代码\">代码<a href=\"post/spd-neteast#代码\"></a></h3><p>因为我考虑弄的是Android的app，但是由于测试，先用Python实现了一下</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 主文件</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests <span class=\"keyword\">as</span> req</span><br><span class=\"line\"><span class=\"keyword\">import</span> netease_crypto</span><br><span class=\"line\"><span class=\"keyword\">import</span> json</span><br><span class=\"line\"></span><br><span class=\"line\">search_str = <span class=\"string\">\"Midsummer Madness\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">query_body = <span class=\"string\">'&#123;\"hlpretag\":\"&lt;span class=\\\\\"s-fc7\\\\\"&gt;\",\"hlposttag\":\"&lt;/span&gt;\",\"s\":\"'</span>+search_str+<span class=\"string\">'\",\"type\":\"1\",\"offset\":\"0\",\"total\":\"true\",\"limit\":\"30\",\"csrf_token\":\"\"&#125;'</span></span><br><span class=\"line\">url = <span class=\"string\">\"https://music.163.com/weapi/cloudsearch/get/web?csrf_token=\"</span></span><br><span class=\"line\">params = netease_crypto.d(query_body)</span><br><span class=\"line\">data = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"params\"</span>:params,</span><br><span class=\"line\">    <span class=\"string\">\"encSecKey\"</span>:<span class=\"string\">\"0c76e2da719b4d3ab2ec44ccdd5100266f4b34cf6d7cd09c4de472aea01de6b1d476918225680680ddee41e02f1a5f19feee10bdea88c0b5bd7661ce5ab06212c7c53cce91d15ff6bc85e995251bb0ad6e240c9f2d4ae3d0631facc1dae8abc24703a66be6b98cd3250e6da7973e0286f7b6e3c1b474c8356961fc2126dc9ea7\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">resp = req.post(url=url,data=data)</span><br><span class=\"line\">jo = json.loads(resp.text)</span><br><span class=\"line\"><span class=\"keyword\">for</span> song <span class=\"keyword\">in</span> jo[<span class=\"string\">'result'</span>][<span class=\"string\">'songs'</span>]:</span><br><span class=\"line\">    print(<span class=\"string\">\"歌曲：\"</span>+song[<span class=\"string\">'name'</span>],end=<span class=\"string\">'   艺术家：'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> artist <span class=\"keyword\">in</span> song[<span class=\"string\">'ar'</span>]:</span><br><span class=\"line\">        print(artist[<span class=\"string\">'name'</span>],end=<span class=\"string\">' / '</span>)</span><br><span class=\"line\">    print()</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># netease_crypto</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">from</span> Crypto.Cipher <span class=\"keyword\">import</span> AES</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">aes_en</span><span class=\"params\">(key,msg)</span>:</span></span><br><span class=\"line\">    cryptor = AES.new(key,AES.MODE_CBC,<span class=\"string\">b'0102030405060708'</span>)</span><br><span class=\"line\">    num = (<span class=\"number\">16</span>-len(msg)%<span class=\"number\">16</span>)</span><br><span class=\"line\">    msg = msg + (chr(num)*num)</span><br><span class=\"line\">    ret = cryptor.encrypt(msg)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> base64.b64encode(ret).decode()</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">d</span><span class=\"params\">(d)</span>:</span></span><br><span class=\"line\">    ret_1 = aes_en(<span class=\"string\">'0CoJUm6Qyw8W8jud'</span>,d)</span><br><span class=\"line\">    print(ret_1)</span><br><span class=\"line\">    ret_2 = aes_en(<span class=\"string\">'pIuxxPXdZv2yDPbr'</span>,ret_1)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> ret_2</span><br></pre></td></tr></table></figure>\n<p>结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">歌曲：Midsummer Madness   艺术家：88rising / Higher Brothers / Rich Brian / Joji / AUGUST 08 / </span><br><span class=\"line\">歌曲：Midsummer Madness(Howie X Remix)   艺术家：孔昊龑Howie X / 88rising / Joji / Higher Brothers / Rich Brian / AUGUST 08 / </span><br><span class=\"line\">歌曲：Midsummer Madness   艺术家：88rising / Higher Brothers / Rich Brian / Joji / AUGUST 08 / </span><br><span class=\"line\">歌曲：Midsummer Madness (KRANE Remix)   艺术家：88rising / KRANE / </span><br><span class=\"line\">歌曲：Midsummer Madness (Cover)   艺术家：Kid Travis / </span><br><span class=\"line\">歌曲：88rising-Midsummer Madness（MISS BLACK TIGER / Lil Sen / TXU徐泽一 remix）   艺术家：MISS BLACK TIGER / Lil Sen / TXU徐泽一 / </span><br><span class=\"line\">歌曲：Midsummer Madness (19KILLS REMIX)   艺术家：19kills / 88rising / </span><br><span class=\"line\">歌曲：Midsummer Madness (Drop-Zone Remix)   艺术家：Mr.Tac / </span><br><span class=\"line\">歌曲：88rising-Midsummer Madness（BEAUZ remix）   艺术家：BEAUZ / </span><br><span class=\"line\">歌曲：Midsummer Madness   艺术家：Instrumental Soon / </span><br><span class=\"line\">歌曲：Midsummer Madness   艺术家：Ivor Slaney &amp; His Orchestra / Dolores Ventura / Ivor Slaney / </span><br><span class=\"line\">歌曲：Midsummer Madness   艺术家：Kid Creole &amp; the Coconuts / </span><br><span class=\"line\">歌曲：Midsummer Madness (Original Mix)   艺术家：Martin DP / </span><br><span class=\"line\">歌曲：Midsummer Madness (Original Mix)   艺术家：Martin DP / </span><br><span class=\"line\">歌曲：Midsummer Madness（Cover：Rich Brian）   艺术家：牟敏雪MichelleBla1r / </span><br><span class=\"line\">歌曲：Midsummer Madness   艺术家：Sherbet / </span><br><span class=\"line\">歌曲：Midsummer Madness（Cover：88rising/joji/Rich Brian/HigherBrothers/AUGUS）   艺术家：金菊 / </span><br><span class=\"line\">歌曲：Midsummer Madness   艺术家：Ivor Slaney &amp; His Orchestra / </span><br><span class=\"line\">歌曲：Midsummer Madness   艺术家：Orchid_J / </span><br><span class=\"line\">歌曲：Midsummer Madness （I N C I D E N T A L）   艺术家：MISERY / </span><br><span class=\"line\">歌曲：Higher Brothers-Midsummer Madness (Remix)（P:ERSIIA / Monster-Jun / MISS BLACK TIGER remix）   艺术家：P:ERSIIA / Monster-Jun / MISS BLACK TIGER / </span><br><span class=\"line\">歌曲：88rising-Midsummer Madness（叵测Cc Remix）   艺术家：叵测Cc / </span><br><span class=\"line\">歌曲：88rising-midsummer madness（叵测Cc Remix）   艺术家：叵测Cc / </span><br><span class=\"line\">...省略</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"值得注意的地方\">值得注意的地方<a href=\"post/spd-neteast#值得注意的地方\"></a></h3><p>别看我说的这么顺，其实实际我自己分析的时候没那么顺，我弄了一上午呢，把坑记录一下，下次注意。</p>\n<p>如果对AES加密本身就很了解的可以忽略。</p>\n<p>首先网易云的aes加密代码使用<code>CryptoJS</code>，我是没找到它的文档。。。我也不知道这是个啥库，因为我没做过JS开发。</p>\n<p>由于AES加密的CBC算法需要加密字符串长度是16的倍数，所以就涉及到补齐问题，我寻思补齐应该是补’\\0’，看各路大佬们写的代码也都是’\\0’，但是<code>CryptoJS</code>默认的补齐方法采用一个叫<code>pkcs7</code>的补齐标准，所以不是补’\\0’，而是补<code>16-len(text)%16</code>对应在ascii表中的字符，所以应该这样写。<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">num = (<span class=\"number\">16</span>-len(text)%<span class=\"number\">16</span>)</span><br><span class=\"line\">text = text + (chr(text)*num)</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"参考\">参考<a href=\"post/spd-neteast#参考\"></a></h3><p><a href=\"https://blog.csdn.net/huuinn/article/details/82762952\" target=\"_blank\" rel=\"noopener\">ubuntu18.04中charles安装及使用-huuinn</a></p>\n","prev":{"title":"Leetcode - Reverse Integer","slug":"lc-reverseinteger"},"next":{"title":"Leetcode - Median of Two Sorted Arrays","slug":"lc-medianoftwosortedarrays"},"link":"http://yoursite.com/post/spd-neteast/","reward":true,"copyright":{"author":"LIL PIG","link":"<a href=\"http://yoursite.com/post/spd-neteast/\" title=\"分析网易云的JS加密\">http://yoursite.com/post/spd-neteast/</a>","license":"Attribution-NonCommercial-NoDerivatives 4.0 International (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}